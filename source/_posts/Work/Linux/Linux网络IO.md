---
title: Linux的五种IO模型
tags: 
categories: Linux
date: 2023-3-21 20:20:00
index_img: 
banner_img: 
math: true
---

## IO调用

我们应用程序是跑在用户空间的，它不存在实质的IO过程，真正的IO是在操作系统执行的。即应用程序的IO操作分为两种动作：IO调用和IO执行。**IO调用是由进程（应用程序的运行态）发起，而IO执行是操作系统内核的工作**。此时所说的IO是应用程序对操作系统IO功能的一次触发，即IO调用

应用程序发起的一次IO操作包含两个阶段：

- **IO调用：应用程序进程向操作系统内核发起调用**
- **IO执行：操作系统内核完成IO操作**



操作系统内核完成IO操作还包括两个过程：

- **准备数据阶段：内核等待I/O设备准备好数据**
- **拷贝数据阶段：将数据从内核缓冲区拷贝到用户进程缓冲区**



## 五种IO模型

网络IO的本质是socket的读取，socket在linux系统被抽象为流，IO可以理解为对流的操作。

对于一次IO访问（以read举例），数据会先被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用程序的地址空间

所以说，当一个read操作发生时，它会经历两个阶段:

- 第一阶段：等待数据准备 (Waiting for the data to be ready)
- 第二阶段：将数据从内核拷贝到进程中 (Copying the data from the kernel to the process)

 

对于socket流而言：

- 第一步：通常涉及等待网络上的数据分组到达，然后被复制到内核的某个缓冲区
- 第二步：把数据从内核缓冲区复制到应用进程缓冲区



网络应用需要处理的无非就是两大类问题，网络IO，数据计算。网络IO的延迟给应用带来的性能瓶颈大于后者

![Linux五种IO模型](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321204440667.png)

网络IO的模型大致有如下几种：

- 同步IO（Synchronous IO）
  - 阻塞IO（Blocking IO）
  - 非阻塞IO（Non-Blocking IO）
  - 多路复用IO（IO Multiplexing）
  - 信号驱动式IO（Signal-Driven IO）
- 异步IO（Asynchronous IO）

### 同步IO

在Linux网络编程中，没有十分可用的异步IO接口，所以在Linux网络编程中，多用同步IO模型。

顾名思义，同步IO要求用户进程在向内核进程发起数据IO请求后，在内核进程读取内核缓冲区中的数据时(若此时内核缓冲区中没有数据，内核进程显然不能返回用户进程需要的数据)，在这一过程中，用户进程需要等待，直到内核进程将数据返回给用户进程，然后用户进程才解除等待/阻塞

这也是默认同步IO模式，也即同步IO阻塞模式



#### 阻塞IO（Blocking IO）

![阻塞IO](http://longls777.oss-cn-beijing.aliyuncs.com/img/640)

这是一种比较传统的IO模型，也是最简单的IO模型，即在读/写数据过程中会发生阻塞现象，简称**BIO**。当进程或线程调用某个条件，当条件不满足则会一直等下去，如果条件满足则执行下一步

**应用进程向操作系统内核，发起recvfrom读取数据，但是内核还没准备好，应用程序就会阻塞，直至内核准备好数据，recvfrom完成数据的复制工作，应用程序结束阻塞状态**

#### 非阻塞IO(Non-Blocking IO)

![非阻塞IO](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321210250929.png)

阻塞式IO的缺点非常明显。如果内核数据一直没准备好，那用户进程将一直阻塞，浪费性能，可以使用非阻塞IO优化，简称**NIO**

当应用进程向内核发起调用时，在目的未达到之前不再一味的等待，而是直接返回，然后通过轮询的方式进行查看内核数据有没有准备好，如果数据准备好了，则将数据复制到用户空间

应用进程不断的通过recvfrom与内核进行交互，直至内核数据准备好。如果数据没有准备好会返回EWOULDBLOCK，应用进程过一段时间再次发送recevfrom请求，在这期间进程可以做其他事情

**虽然NIO大幅提升了性能，但是它依然存在性能问题，即频繁的轮询，导致频繁的系统调用，同样会消耗大量的CPU资源**



#### 多路复用IO（IO Multiplexing）

![多路复用IO](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321210314724.png)

既然NIO无效的轮询会导致CPU资源消耗，我们等到内核数据准备好了，主动通知应用进程再去进行系统调用，那不就好了吗？这就是IO多路复用

**IO复用模型核心思路：** 系统给我们提供一类函数（如**select、poll、epoll** ），它们可以同时监控多个文件描述符(**File Descriptor)**的操作，**其中任何一个返回内核数据就绪时**，应用进程再发起recvfrom系统调用

> [select、poll、epoll详解](https://www.jianshu.com/p/722819425dbd/)

>  **文件描述符(File Descriptor)，**是计算机科学中的一个术语，是一个用于表述指向文件的引用的抽象化概念，在形式上是一个非负整数。实际上，它是一个**索引值**，**指向内核为每一个进程所维护的该进程打开文件的记录表**。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开，但是文件描述符这一概念往往只适用于UNIX、Linux这样的操作系统



##### IO多路复用使用场合：

1. 当客户处理多个描述符时（一般是交互式输入和网络套接字），必须使用I/O复用
2. 当一个客户同时处理多个套接字时，而这种情况是可能的，但很少出现
3. 如果一个TCP服务器既要处理监听套接字，又要处理已连接套接字，一般也要用到I/O复用
4. 如果一个服务器即要处理TCP，又要处理UDP，一般要使用I/O复用
5. 如果一个服务器要处理多个服务或多个协议，一般要使用I/O复用

> **redis用的就是IO多路复用**



#### 信号驱动式IO（Signal-Driven IO）

![信号驱动IO](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321210350936.png)

信号驱动IO不再用主动询问的方式去确认数据是否就绪，而是向内核发送一个信号（调用sigaction的时候建立一个SIGIO的信号），然后应用用户进程可以去做别的事，不用阻塞。当内核数据准备好后，再通过SIGIO信号通知应用进程，数据准备好后的可读状态。应用用户进程收到信号之后，立即调用recvfrom，去读取数据。

> **应用进程预先往内核注册一个信号处理函数，然后用户进程不会阻塞直接返回，当内核数据准备就绪会发送一个信号给进程，用户进程在信号处理含函数中把数据复制到用户空间。**

不管是BIO，还是NIO，还是信号驱动，在数据从内核复制到应用缓冲的时候，都是阻塞的，还有没有优化方案呢？AIO（真正的异步IO）！



### 异步IO（Asynchronous IO）

![异步IO](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321210412838.png)

前面讲的BIO，NIO和信号驱动，在数据从内核复制到应用缓冲的时候，都是阻塞的，因此都不算是真正的异步。AIO实现了IO全流程的非阻塞，就是应用进程发出系统调用后，是立即返回的，但是立即返回的不是处理结果，而是表示提交成功类似的意思。等内核数据准备好，将数据拷贝到用户进程缓冲区，发送信号通知用户进程IO操作执行完毕

> **用户发起aio_read操作之后，会给内核传递描述符，缓冲区指针、缓冲区大小，告诉内核当整个操作完成时，如何通知进程，然后就可以立即做其他事情了。让内核收到aio_read后，会立即返回，然后开始等待数据准备，数据准备好之后，直接把数据复制到用户空间，然后通知进程本次IO完成**

### 5种IO模型对比

![5种IO模型对比](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230321221038739.png)



## BIO、NIO、AIO

- **同步阻塞(Blocking-IO)：简称BIO，适用于连接数目小的架构，这种方式对服务器资源要求比较高，但BIO直观、简单、易理解**
- **同步非阻塞(Non-Blocking-IO)：简称NIO，适用于连接数目多，且比较短的架构，比如聊天服务器**
- **异步非阻塞(Asynchronous-Non-Blocking-IO)：简称AIO，适用于连接数目多且连接比较长的架构，如相册服务器**

 





> https://mp.weixin.qq.com/s/U2xJgL7rPqOJ8in-V-Ck6A
>
> https://blog.csdn.net/qq_33429968/article/details/124872712
>
> https://blog.csdn.net/weixin_45819295/article/details/125806616