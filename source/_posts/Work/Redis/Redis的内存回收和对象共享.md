---
title: Redis的内存回收和对象共享
tags: 
categories: Redis
date: 2023-2-15 10:05:00
index_img: 
banner_img: 
math: true
---



## 内存回收

因为C语言并不具备自动内存回收功能，所以Redis在自己的对象系统中构建了一个引用计数（reference counting）技术实现的内存回收机制，通过这一机制，程序可以通过跟踪对象的引用计数信息，在适当的时候自动释放对象并进行内存回收

对象的引用计数信息会随着对象的使用状态而不断变化：

- 在创建一个新对象时，引用计数的值会被初始化为1
- 当对象被一个新程序使用时，它的引用计数值会被增一
- 当对象不再被一个程序使用时，它的引用计数值会被减一
- 当对象的引用计数值变为0时，对象所占用的内存会被释放

## 对象共享

除了用于实现引用计数内存回收机制之外，对象的引用计数属性还带有对象共享的作用

举个例子，假设键A创建了一个包含整数值100的字符串对象作为值对象。如果这时键B也要创建一个同样保存了整数值100的字符串对象作为值对象，那么服务器有以下两种做法：

1. 为键B新创建一个包含整数值100的字符串对象
2. 让键A和键B共享同一个字符串对象

很明显第二种方法更节约内存

在Redis中，让多个键共享同一个值对象需要执行以下两个步骤：

1. 将数据库键的值指针指向一个现有的值对象
2. 将被共享的值对象的引用计数增一

![image-20230215101042640](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230215101042640.png)

> **为什么Redis不共享包含字符串的对象?**
>
> 当服务器考虑将一个共享对象设置为键的值对象时，程序需要先检查给定的共享对象和键想创建的目标对象是否完全相同，只有在共享对象和目标对象完全相同的情况下，程序才会将共享对象用作键的值对象，而一个共享对象保存的值越复杂，验证共享对象和目标对象是否相同所需的复杂度就会越高，消耗的CPU时间也会越多：
>
> - 如果共享对象是保存整数值的字符串对象，那么验证操作的复杂度为O(1)
> - 如果共享对象是保存字符串值的字符串对象，那么验证操作的复杂度为O(N)
> - 如果共享对象是包含了多个值（或者对象的）对象，比如列表对象或者哈希对象，那么验证操作的复杂度将会是O(N^2)
>
> 因此，尽管共享更复杂的对象可以节约更多的内存，但受到CPU时间的限制，**Redis只对包含整数值的字符串对象进行共享**