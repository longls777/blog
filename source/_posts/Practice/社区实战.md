---
title: 社区架构（SpringBoot+MySQL+Redis）
tags: 
categories: Practice
date: 2023-04-08 20:38:00
index_img: 
banner_img: 
---

## 数据库表

**用户表**

![image-20230408210719390](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408210719390.png)

```sql
CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT NULL,
  `password` varchar(50) DEFAULT NULL,
  `salt` varchar(50) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `type` int DEFAULT NULL COMMENT '0-普通用户; 1-超级管理员; 2-版主;',
  `status` int DEFAULT NULL COMMENT '0-未激活; 1-已激活;',
  `activation_code` varchar(100) DEFAULT NULL,
  `header_url` varchar(200) DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_username` (`username`(20)),
  KEY `index_email` (`email`(20))
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**讨论贴表**

![image-20230408210740808](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408210740808.png)

```sql
CREATE TABLE `discuss_post` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` varchar(45) DEFAULT NULL,
  `title` varchar(100) DEFAULT NULL,
  `content` text,
  `type` int DEFAULT NULL COMMENT '0-普通; 1-置顶;',
  `status` int DEFAULT NULL COMMENT '0-正常; 1-精华; 2-拉黑;',
  `create_time` timestamp NULL DEFAULT NULL,
  `comment_count` int DEFAULT NULL,
  `score` double DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**信息表**

![image-20230408210800571](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408210800571.png)

```sql
CREATE TABLE `message` (
  `id` int NOT NULL AUTO_INCREMENT,
  `from_id` int DEFAULT NULL,
  `to_id` int DEFAULT NULL,
  `conversation_id` varchar(45) NOT NULL,
  `content` text,
  `status` int DEFAULT NULL COMMENT '0-未读;1-已读;2-删除;',
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_from_id` (`from_id`),
  KEY `index_to_id` (`to_id`),
  KEY `index_conversation_id` (`conversation_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**评论表**

![image-20230408210842413](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408210842413.png)

```sql
CREATE TABLE `comment` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int DEFAULT NULL,
  `entity_type` int DEFAULT NULL,
  `entity_id` int DEFAULT NULL,
  `target_id` int DEFAULT NULL,
  `content` text,
  `status` int DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`) /*!80000 INVISIBLE */,
  KEY `index_entity_id` (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**登陆凭证表**

![image-20230408210827648](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408210827648.png)

```sql
CREATE TABLE `login_ticket` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `ticket` varchar(45) NOT NULL,
  `status` int DEFAULT '0' COMMENT '0-有效; 1-无效;',
  `expired` timestamp NOT NULL,
  PRIMARY KEY (`id`),
  KEY `index_ticket` (`ticket`(20))
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



## 实体

**User**

![image-20230408212318250](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408212318250.png)

**Page**

![image-20230408212829416](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408212829416.png)

**DiscussPost**

![image-20230408212846297](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408212846297.png)

**Comment**

![image-20230408212923234](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408212923234.png)

**LoginTicket**

![image-20230408213206414](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408213206414.png)



DAO和mapper不再记录，就是一些增删改查操作，看源码



## 用户注册和激活

![img](http://longls777.oss-cn-beijing.aliyuncs.com/img/clipboard.png)

**用户注册和激活流程：**

1. 值检测（check value），包括传入值是否有效，账号邮箱是否已经被注册等
2. 注册账号，使用UUID前五位作为salt，和密码concat然后md5加密，设置激活码为UUID

![image-20230408214223149](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408214223149.png)

3. 发送激活邮件，使用userID和激活码作为激活URL，使用Thylemeaf模板引擎生成邮件正文内容

![image-20230408214508509](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408214508509.png)

4. 用户访问邮件中的激活URL，比对和数据库中存储的激活码

![image-20230408214812825](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408214812825.png)

这里有一个@PathVariable 注释，可以将请求URL中的占位符（即路径变量）绑定到控制器方法的参数上

![image-20230408215140085](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408215140085.png)



## 用户登录和退出

![clipboard2](http://longls777.oss-cn-beijing.aliyuncs.com/img/clipboard2.png)

**用户登录流程**

1. 首先生成验证码，将验证码内容存入HttpSession，图片传入HttpServletResponse

![image-20230408220221737](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408220221737.png)

2. 登陆时，判断验证码是否正确，并根据是否“记住我”确定ticket超时时间

![image-20230408220606198](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408220606198.png)

3. 值检测，包括验证是否激活，验证密码等

![image-20230408220804748](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408220804748.png)

4. 生成登陆凭证（ticket），其中ticket字段是一个UUID

![image-20230408221216211](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408221216211.png)

5. 将ticket字段作为cookie返回

![image-20230408221358487](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408221358487.png)



**用户退出流程**

1. 从请求中取出ticket

![image-20230408222358944](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408222358944.png)

2. 设置数据库中对应ticket过期

![image-20230408222451805](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408222451805.png)



## 登录拦截



![clipboard3](http://longls777.oss-cn-beijing.aliyuncs.com/img/clipboard3.png)

1. 设置注解@LoginRequired

![image-20230408222728271](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408222728271.png)

2. 使用ThreadLocal代替session持有用户信息

![image-20230408223129635](http://longls777.oss-cn-beijing.aliyuncs.com/img/image-20230408223129635.png)



> 好处是什么？
>
> 使用ThreadLocal变量代替session的主要原因是为了避免多线程并发访问时的线程安全问题。
>
> 在Web应用程序中，多个用户同时访问同一个Servlet或JSP页面时，每个用户的请求都会在一个独立的线程中执行。如果使用session来存储用户信息，那么多个线程会共享同一个session对象，这就会导致线程安全问题。
>
> 为了解决这个问题，可以使用ThreadLocal变量来存储用户信息。ThreadLocal是Java中的一个线程局部变量，它可以为每个线程提供独立的变量副本，使得多个线程可以同时访问同一个变量，而不会出现线程安全问题。

3. 设置LoginTicketInterceptor，将用户信息存储到HostHolder

...